---
# tasks file for ansible-role-bitwarden
- name: install the latest version of docker, docker-compose and unzip
  package:
    name:
      - docker
      - docker-compose
      - unzip
    state: latest
- name: Start docker service
  service:
    name: docker
    state: started
    enabled: yes

# Step 1
- name: Download docker compose file
  get_url:
    url: https://github.com/bitwarden/server/releases/download/v1.32.0/docker-stub.zip
    dest: /tmp/docker-stub.zip
    mode: 0777

# Step 2
- name: Create bwdata folder
  file: path=/tmp/bwdata state=directory
- name: Extract docker-stub.zip into bwdata/docker-stub/
  become: yes
  unarchive:
    src: /tmp/docker-stub.zip
    dest: /tmp/bwdata
    remote_src: yes

# Step 3
- name: Enter installation id in ./bwdata/env/global.override.env
  lineinfile:
    path: /tmp/bwdata/env/global.override.env
    regexp: 'globalSettings__installation__id'
    line: globalSettings__installation__id={{ bitwarden_installation_id }}
- name: Enter installation key in ./bwdata/env/global.override.env
  lineinfile:
    path: /tmp/bwdata/env/global.override.env
    regexp: 'globalSettings__installation__key'
    line: globalSettings__installation__key={{ bitwarden_installation_key }}

# Step 4
- name: Replace vault service url in ./bwdata/env/global.override.env
  lineinfile: 
    path: /tmp/bwdata/env/global.override.env
    regexp: 'globalSettings__baseServiceUri__vault='
    line: globalSettings__baseServiceUri__vault=https://{{ bitwarden_hostname }}/

- name: Replace api service url in ./bwdata/env/global.override.env
  lineinfile: 
    path: /tmp/bwdata/env/global.override.env
    regexp: 'globalSettings__baseServiceUri__api='
    line: globalSettings__baseServiceUri__api=https://{{ bitwarden_hostname }}/api

- name: Replace identity service url in ./bwdata/env/global.override.env
  lineinfile: 
    path: /tmp/bwdata/env/global.override.env
    regexp: 'globalSettings__baseServiceUri__identity='
    line: globalSettings__baseServiceUri__identity=https://{{ bitwarden_hostname }}/identity

- name: Replace admin service url in ./bwdata/env/global.override.env
  lineinfile: 
    path: /tmp/bwdata/env/global.override.env
    regexp: 'globalSettings__baseServiceUri__admin='
    line: globalSettings__baseServiceUri__admin=https://{{ bitwarden_hostname }}/admin

- name: Replace notifications service url in ./bwdata/env/global.override.env
  lineinfile: 
    path: /tmp/bwdata/env/global.override.env
    regexp: 'globalSettings__baseServiceUri__notifications='
    line: globalSettings__baseServiceUri__notifications=https://{{ bitwarden_hostname }}/notifications

- name: Replace attachment base url in ./bwdata/env/global.override.env
  lineinfile: 
    path: /tmp/bwdata/env/global.override.env
    regexp: 'globalSettings__attachment__baseUrl='
    line: globalSettings__attachment__baseUrl=https://{{ bitwarden_hostname }}/attachments

# Step 5
# https://docs.ansible.com/ansible/latest/modules/win_certificate_store_module.html
# Generate a .pfx certificate file for the identity container and place it in the mapped volume directory at ./identity/identity.pfx.
# Nog bekijken


# Step 6
# https://docs.ansible.com/ansible/latest/modules/openssl_certificate_module.html
# Copy your SSL certificate and keys to the ./ssl directory. By default, this directory is mapped to the nginx container at /etc/ssl. The ./nginx/default.conf can be adjusted to utilize these certificates as desired.

# Step 7

# Step 8
# https://docs.ansible.com/ansible/latest/plugins/lookup/password.html

# Step 9

# Step 10

# Step 11
# https://docs.ansible.com/ansible/latest/modules/user_module.html

# Step 12
# https://docs.ansible.com/ansible/latest/modules/docker_compose_module.html